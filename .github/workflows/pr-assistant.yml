name: PR Assistant

on:
  pull_request:

permissions:
  contents: read
  pull-requests: write

jobs:
  pr_assistant:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Run tests
        run: node --test

      - name: Run rmemo check (staged)
        run: |
          node bin/rmemo.js init
          node bin/rmemo.js --staged check

      - name: Generate rmemo outputs
        env:
          BASE_REF: ${{ github.base_ref }}
        run: |
          set -euo pipefail
          base="origin/${BASE_REF}"
          echo "Base ref: $base"
          node bin/rmemo.js --base "$base" pr
          node bin/rmemo.js --since "$base" handoff

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rmemo
          path: |
            .repo-memory/context.md
            .repo-memory/handoff.md
            .repo-memory/pr.md

      - name: Comment on PR (rmemo)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const marker = '<!-- rmemo-pr-assistant -->';
            function read(p) {
              try { return fs.readFileSync(p, 'utf8'); } catch { return ''; }
            }

            const pr = read('.repo-memory/pr.md');
            const handoff = read('.repo-memory/handoff.md');
            const ctx = read('.repo-memory/context.md');

            const clip = (s, max = 60000) => s.length > max ? (s.slice(0, max) + '\n\n[...truncated]') : s;

            const body = [
              marker,
              '## rmemo PR Assistant',
              '',
              '<details>',
              '<summary>PR Summary</summary>',
              '',
              clip(pr || '(missing .repo-memory/pr.md)'),
              '</details>',
              '',
              '<details>',
              '<summary>Handoff</summary>',
              '',
              clip(handoff || '(missing .repo-memory/handoff.md)'),
              '</details>',
              '',
              '<details>',
              '<summary>Context Pack (head)</summary>',
              '',
              clip(ctx || '(missing .repo-memory/context.md)', 15000),
              '</details>',
              ''
            ].join('\n');

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;
            const comments = await github.paginate(github.rest.issues.listComments, { owner, repo, issue_number, per_page: 100 });
            const existing = comments.find(c => (c.body || '').includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body });
            }
