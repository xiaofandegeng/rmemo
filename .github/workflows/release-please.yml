name: Release Please

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    concurrency:
      group: release-please
      cancel-in-progress: true
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
    steps:
      - id: release
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  publish-from-release-please:
    needs: release-please
    if: needs.release-please.outputs.releases_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: "https://registry.npmjs.org"

      - name: Resolve version + dist-tag
        id: vars
        run: |
          VERSION="$(node -p "require('./package.json').version")"
          DIST_TAG="latest"
          if echo "$VERSION" | grep -q '-'; then
            DIST_TAG="next"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "dist_tag=$DIST_TAG" >> "$GITHUB_OUTPUT"

      - name: Run tests
        run: node --test

      - name: Publish to npm (skip if already published)
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          npm_config_cache: .npm-cache
        run: |
          PKG="$(node -p "require('./package.json').name")"
          V="${{ steps.vars.outputs.version }}"
          if npm view "$PKG@$V" version >/dev/null 2>&1; then
            echo "Already published: $PKG@$V (skipping)"
            exit 0
          fi
          npm whoami
          npm publish --tag "${{ steps.vars.outputs.dist_tag }}"

      - name: Build npm tarball (for release assets)
        run: npm_config_cache=.npm-cache npm pack

      - name: Upload release assets (tgz)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const path = require("path");
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tag = "v${{ steps.vars.outputs.version }}";
            
            // Try to find the release matching the tag created by release-please
            let release_id;
            try {
              const rel = await github.rest.repos.getReleaseByTag({ owner, repo, tag });
              release_id = rel.data.id;
            } catch (e) {
              core.warning(`Release ${tag} not found. Ensure release-please created it.`);
              return;
            }

            const files = fs.readdirSync(process.cwd()).filter((f) => f.endsWith(".tgz"));
            if (!files.length) {
              core.info("No .tgz files found to upload.");
              return;
            }

            const assets = await github.paginate(github.rest.repos.listReleaseAssets, { owner, repo, release_id, per_page: 100 });
            const byName = new Map(assets.map((a) => [a.name, a]));

            for (const f of files) {
              const existing = byName.get(f);
              if (existing) {
                core.info(`Deleting existing asset: ${f}`);
                await github.rest.repos.deleteReleaseAsset({ owner, repo, asset_id: existing.id });
              }
              const data = fs.readFileSync(path.join(process.cwd(), f));
              core.info(`Uploading asset: ${f} (${data.length} bytes)`);
              await github.rest.repos.uploadReleaseAsset({
                owner,
                repo,
                release_id,
                name: f,
                data,
                headers: {
                  "content-type": "application/octet-stream",
                  "content-length": data.length
                }
              });
            }

      - name: Verify Publish Success (Post-Release)
        run: |
          PKG="$(node -p "require('./package.json').name")"
          V="${{ steps.vars.outputs.version }}"
          echo "Verifying $PKG@$V exists on NPM registry..."
          
          # We retry max 5 times, sleeping 10s between checks to allow NPM CDN propagation
          for i in 1 2 3 4 5; do
            if npm view "$PKG@$V" version >/dev/null 2>&1; then
              echo "✅ Successfully verified $PKG@$V is published."
              exit 0
            fi
            echo "Waiting for NPM to register $V (attempt $i/5)..."
            sleep 10
          done
          echo "❌ Failed to verify $PKG@$V on NPM."
          exit 1
          
      - name: Output Diagnostic Envelope on Failure
        if: failure()
        run: |
          echo "::group::Rmemo Diagnostics Dump"
          node ./bin/rmemo.js diagnostics export --format json || echo "Failed to run diagnostics."
          echo "::endgroup::"
