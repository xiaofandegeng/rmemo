name: Publish (tag)

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: "https://registry.npmjs.org"

      - name: Resolve version + dist-tag
        id: vars
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          DIST_TAG="latest"
          if echo "$VERSION" | grep -q '-'; then
            DIST_TAG="next"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "dist_tag=$DIST_TAG" >> "$GITHUB_OUTPUT"

      - name: Verify package.json version matches tag
        run: |
          node -e "const pkg=require('./package.json'); const v='${{ steps.vars.outputs.version }}'; if(pkg.version!==v){ console.error('package.json version mismatch:', pkg.version, '!=', v); process.exit(1)}"

      - name: Run tests
        run: node --test

      - name: Generate release notes (CHANGELOG.md or git log)
        run: |
          TAG="${{ steps.vars.outputs.tag }}"
          VERSION="${{ steps.vars.outputs.version }}"
          # Prefer CHANGELOG.md section for this version if present.
          if [ -f CHANGELOG.md ]; then
            BODY="$(awk -v ver="$VERSION" '
              BEGIN { in=0 }
              $0 ~ ("^##[[:space:]]+" ver "([[:space:]]|$)") { in=1; next }
              in && /^##[[:space:]]+/ { exit }
              in { print }
            ' CHANGELOG.md | sed -e 's/[[:space:]]*$//')"
          fi

          PREV="$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || true)"
          echo "# ${TAG}" > release-notes.md
          echo "" >> release-notes.md
          if [ -n "${BODY:-}" ]; then
            echo "${BODY}" >> release-notes.md
            echo "" >> release-notes.md
          elif [ -n "$PREV" ]; then
            echo "## Changes (${PREV}..${TAG})" >> release-notes.md
            echo "" >> release-notes.md
            git log --pretty=format:"- %s (%h)" "${PREV}..${TAG}" >> release-notes.md
            echo "" >> release-notes.md
          else
            echo "## Changes" >> release-notes.md
            echo "" >> release-notes.md
            git log --pretty=format:"- %s (%h)" "${TAG}" >> release-notes.md
            echo "" >> release-notes.md
          fi

      - name: Build npm tarball (for release assets)
        run: npm_config_cache=.npm-cache npm pack

      - name: Publish to npm (skip if already published)
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          npm_config_cache: .npm-cache
        run: |
          PKG="$(node -p "require('./package.json').name")"
          V="${{ steps.vars.outputs.version }}"
          if npm view "$PKG@$V" version >/dev/null 2>&1; then
            echo "Already published: $PKG@$V (skipping)"
            exit 0
          fi
          npm whoami
          npm publish --tag "${{ steps.vars.outputs.dist_tag }}"

      - name: Check if GitHub Release exists
        id: gh
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tag = "${{ steps.vars.outputs.tag }}";
            try {
              const r = await github.rest.repos.getReleaseByTag({ owner, repo, tag });
              core.setOutput("exists", "true");
              core.setOutput("id", String(r.data.id));
              const body = typeof r.data.body === "string" ? r.data.body.trim() : "";
              core.setOutput("body_empty", body ? "false" : "true");
            } catch (e) {
              if (e?.status === 404) {
                core.setOutput("exists", "false");
                core.setOutput("body_empty", "true");
              } else {
                throw e;
              }
            }

      - name: Create GitHub Release (only if missing)
        if: steps.gh.outputs.exists != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: ${{ steps.vars.outputs.tag }}
          body_path: release-notes.md
          prerelease: ${{ steps.vars.outputs.dist_tag == 'next' }}

      - name: Update GitHub Release body (only if empty)
        if: steps.gh.outputs.exists == 'true' && steps.gh.outputs.body_empty == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const release_id = Number("${{ steps.gh.outputs.id }}");
            const body = fs.readFileSync("release-notes.md", "utf8");
            core.info(`Updating release ${release_id} body (was empty)`);
            await github.rest.repos.updateRelease({ owner, repo, release_id, body });

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          files: "*.tgz"
