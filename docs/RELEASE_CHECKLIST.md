# Release Checklist

This checklist is the single source of truth for shipping `rmemo` releases.

## 1. Preflight

- [ ] `git pull --ff-only origin main`
- [ ] `git status --short` is clean
- [ ] Preferred one-command rehearsal:
  - [ ] `npm run verify:release-rehearsal -- --repo xiaofandegeng/rmemo`
- [ ] `node --test`
- [ ] `npm run pack:dry`
- [ ] `npm run verify:changelog`
- [ ] `node bin/rmemo.js contract check --format json --fail-on any`
- [ ] `npm run verify:matrix`
- [ ] `npm run verify:release-ready`
  - [ ] Optional timeout guard: `node scripts/release-ready.js --format md --step-timeout-ms 120000`
- [ ] Archive readiness report:
  - [ ] `node scripts/release-ready.js --format md --out artifacts/release-ready.md`
  - [ ] `node scripts/release-ready.js --format json --out artifacts/release-ready.json`
  - [ ] `artifacts/release-notes.md`
  - [ ] `artifacts/release-health.md`
  - [ ] `artifacts/release-health.json`
  - [ ] `artifacts/release-rehearsal.md`
  - [ ] `artifacts/release-rehearsal.json`

## 2. Version + notes preparation

- [ ] Confirm `CHANGELOG.md` includes this iteration's user-visible changes
- [ ] Confirm docs are updated:
  - [ ] `README.md`
  - [ ] `README.zh-CN.md`
  - [ ] `docs/CONTRACTS.md` (if contract behavior changed)
  - [ ] `docs/REGRESSION_MATRIX.md` (if verification flow changed)

## 3. Release automation path

Release is driven by `release-please` on `main` push.

- [ ] Ensure workflow permissions are enabled:
  - [ ] `Read and write permissions`
  - [ ] `Allow GitHub Actions to create and approve pull requests`
- [ ] Ensure `NPM_TOKEN` secret is valid for publish scope
- [ ] Confirm `Release Please` workflow uses retry-once guard for transient API failures
- [ ] Merge release PR generated by `release-please`

## 4. Post-release health validation

- [ ] Verify npm package is published:
  - [ ] `npm view @xiaofandegeng/rmemo@<version> version`
- [ ] Verify GitHub Release exists for tag `v<version>`
- [ ] Download release audit artifact:
  - [ ] `rmemo-release-audit-<version>`
- [ ] Run:
  - [ ] `node scripts/release-health.js --repo xiaofandegeng/rmemo --version <version> --tag v<version> --format md`
- [ ] Confirm release assets contain expected `.tgz` file

## 5. Failure handling

If release workflow fails:

- [ ] Check workflow logs for failing step
- [ ] If `release-please` failed with HTML/`Unicorn` response, re-run workflow first (transient GitHub API failure path)
- [ ] Download workflow artifact:
  - [ ] `rmemo-release-diagnostics-<version>` (release workflow)
  - [ ] `rmemo-ci-diagnostics-node-<node>` (CI workflow)
- [ ] Export diagnostics:
  - [ ] `node bin/rmemo.js diagnostics export --format json`
- [ ] Confirm whether failure is:
  - [ ] Contract drift
  - [ ] Matrix regression
  - [ ] npm auth/publish
  - [ ] GitHub release API/asset upload
- [ ] Re-run job only after root cause is fixed

## 6. Final sign-off

- [ ] GitHub Release page has notes + assets
- [ ] npm page shows expected latest version/tag
- [ ] `docs/NEXT_CYCLE_PLAN.md` progress checkboxes updated
- [ ] Next iteration entry task identified
